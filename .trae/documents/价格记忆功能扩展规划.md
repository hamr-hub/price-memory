## 现状概览
- 已有核心：`products` 与 `prices` 按时间序列记录，任务（抓取）流转，产品详情含 `min/max/avg` 统计，单/多商品 CSV 导出，集合 Excel 导出，关注/公共池与分享协作。
- 不足与机会：抓取为桩实现（固定价格），`last_updated` 未随价格刷新，缺少跨站同款比价、趋势可视化、阈值提醒、聚合与预测等常见能力。

## 常用功能清单（优先补齐）
- 基础抓取与调度：接入真实站点解析、轮询与失败重试、分布式并发与速率限制。
- 价格走势与筛选：折线图/蜡烛图、时间范围与粒度（日/周/月），按涨跌幅、区间、类别过滤排序。
- 聚合与统计：按日/周生成 `open/high/low/close/avg` 与涨跌幅、最近 N 次统计、区间对比。
- 阈值提醒：支持“低于 X 价格/跌幅≥Y%”等规则，邮件/站内/Webhook 推送，静默期与去重。
- 同款比价：同商品在不同平台的当前价与历史价对比，显示最低价与节省金额。
- 批量管理：CSV/Excel 导入商品、批量创建抓取任务、批量导出选中商品历史。
- 收藏/标签：商品收藏、用户自定义标签与分组，便于筛选与导出。
- 数据质量：去重（同一产品同一时刻）、异常值屏蔽（超阈）、空值/解析失败标记与回滚。

## 有趣功能创意（增值与差异化）
- 智能优惠发现：结合历史与当前价，识别“历史低价/年度低价/近期最低”，推送“捡漏”提示。
- 趋势与季节性分析：移动均线、布林带、季节因素（促销周期）提示，帮助择时购买。
- 价格预测：基于时间序列模型（ARIMA/Prophet/LightGBM），给出短期价格预估区间与信心度。
- 异常检测：爬取波动异常、价格跳变/回填异常自动诊断与告警。
- 跨站同款匹配：基于标题/图片/属性相似度聚类，自动归并同款，支撑全网比价。
- 优惠券/运费整合：结算价 = 商品价 - 优惠券 + 运费，展示真实到手价与比价结果。
- 预算助手：为收藏夹设预算，超预算提醒与推荐替代品（同类更优性价比）。
- 社区趋势：公共池商品热度榜（关注/分享/价变事件），热门降价订阅。
- 自动日报/周报：为个人或团队自动生成降价日报与趋势周报，邮件附件/Webhook 投递。

## 技术改造点（后端与数据层）
- 模型扩展：
  - `price_sources`（站点/商家）、`product_aliases`（同款映射）、`price_aggregates_daily`（OHLC/avg/vol）、`alerts` 与 `notifications`（规则与推送）。
  - `prices` 增加 `currency/source/raw_meta`；`products` 维护 `last_price/last_updated` 与索引。
- 抓取管线：真实解析（Playwright/Requests-HTML）、轮换代理与指纹、失败重试与断路器；解析模板化与回放快照（截图/HTML 摘要）。
- 任务调度：优先队列（关注/热门优先）、时间窗调度（昼夜/促销期）、退避策略。
- 聚合计算：ETL 定时将 `prices` 汇总到 `price_aggregates_daily`；提供区间聚合查询与导出。
- 告警与通知：规则引擎（条件/静默/触发器），邮件/Webhook/Slack 通道，投递日志与重试。
- 比价与匹配：相似度计算（标题/属性/图像哈希），同款归并，跨源最低价 API。
- API 扩展：趋势、聚合、预测、比价、告警 CRUD/查询/订阅，批量导入与校验端点。

## 前端改造点（管理端与用户侧）
- 趋势视图：商品详情新增趋势图（切换粒度/指标），历史低价标记与区间对比。
- 比价视图：同款跨站并排对比卡片，当前最低价与到手价计算。
- 告警中心：创建/编辑规则、查看触发历史与推送状态、测试规则。
- 批量操作：导入向导、批量任务与批量标签，列表多选导出。
- 收藏与标签：筛选面板（标签/分组/价格区间/站点），保存视图与快捷导出。
- 抓取监控：任务页显示队列、成功率、失败原因；一键重试与速率控制。

## 数据治理与运维
- 质量指标：解析成功率、异常比率、去重比率、价格波动分布，按源与类别维度监控。
- 反爬与合规：速率限制、Robots/条款审阅、日志脱敏与访问审计。
- 成本控制：代理与执行成本监控，任务优先级与配额（个人/团队）。
- 可靠性：幂等写入、去重键（product_id+source+time_bucket）、事务与重试策略。

## 优先级建议
- P0：真实抓取与调度、聚合与趋势图、阈值提醒、数据质量与去重、`last_updated` 正确维护。
- P1：同款比价与到手价、批量导入/导出、收藏/标签与筛选、抓取监控面板。
- P2：智能优惠与异常检测、价格预测、社区趋势与自动日报。

## 产出示例（落地后可见）
- 新 API：`GET /products/{id}/trend?granularity=daily`、`POST /alerts`、`GET /compare?product_id=...` 等。
- 新表与索引：`price_aggregates_daily(product_id,date,open,high,low,close,avg)`；`alerts(product_id,rule,channel,status)`；`prices` 增列索引。
- 新页面：趋势/比价/告警中心与批量导入页；列表筛选与收藏标签。

请确认上述规划方向与优先级，我将据此细化接口契约与页面原型，并开始逐项实现与验证。