## 协作目标
- 完整打通 Supabase 持久化与 Playwright 抓取管线，提升稳定性与可维护性
- 以表格为核心的前端展示：筛选、排序、分页、导出与批量操作
- 引入任务队列与限速策略，兼容 Amazon 多区域（.com/.co.uk/.de/.jp 等）
- 建立监控、测试与发布流水线，保障质量与性能

## 多智能体分工
- Python架构师：设计抓取架构、反爬策略、并发控制与可观测性
- 服务端实现师：落地 Supabase 数据访问层与 FastAPI 端点、任务调度与导出
- 前端实现师：实现表格模块、搜索筛选、详情页、导出与收藏
- React架构师专家：性能优化（虚拟列表、请求缓存）、Vite 配置与工程规范
- 测试专家：单元/集成/E2E 测试覆盖抓取解析、API 与前端交互
- 产品设计师：用户流程（添加/收藏/抓取/导出）、交互与信息架构

## 后端优化（Supabase + Playwright）
1. Supabase 表与索引
- products(id,name,url,category,current_price,currency,asin,created_at,last_updated)
- price_records(id,product_id,price,currency,recorded_at,source) 索引：product_id+recorded_at
- spider_tasks(id,product_id,status,scheduled_at,started_at,completed_at,result_message)
- user_favorites(id,user_id,product_id,created_at)（可选）
2. 数据访问层
- 封装 Supabase Client：统一重试、超时、分页；入库前标准化字段
- 幂等写入：同秒同价记录去重（可选）
3. Playwright 抓取稳健性
- 反爬策略：随机 UA、语言/时区、离散延时、请求拦截白名单
- 选择器兜底：多站点差异选择器、容错提取（价格文案与数字分离）
- 失败重试与快照：解析失败保存 HTML 片段与截图到本地或存储（可选）
4. 任务编排与速率限制
- 任务队列：pending→running→completed/failed；并发上限、站点/区域速率限制
- 调度器：周期任务（如每日/每小时刷新收藏商品）
5. API 增强
- 列表分页/筛选/排序；详情带趋势统计；批量导出（多商品）
- 安全：JWT 认证、RBAC（管理员/普通用户）
6. 导出能力
- Excel（openpyxl）与 CSV（流式）导出；支持按时间范围筛选

## 前端优化（表格展示为核心）
1. 商品列表页
- 表格列：商品名、站点、链接、当前价、货币、更新时间、操作
- 功能：搜索（名称/ASIN）、分类筛选、价格区间筛选、分页与排序
- 批量操作：批量抓取、批量导出
2. 详情页
- 历史价格折线图（时间轴）与统计（min/max/avg）
- 规格/ASIN/图片展示；一键加入收藏
3. 列表抓取向导
- 输入 Amazon 搜索/类目链接 → 预览列表 → 勾选目标 → 批量加入监控
4. 体验与性能
- 虚拟列表（大量数据）、请求缓存与并发控制、错误提示与重试
- 配置 `VITE_API_URL` 与环境切换（开发/生产）

## 监控与质量保障
- 日志与指标：请求耗时、任务成功率、解析失败率；错误告警（Sentry 可选）
- 测试矩阵：
  - 解析器单元测试（多区域选择器与货币解析）
  - API 集成测试（Supabase Mock 或测试项目）
  - E2E 测试（前端表格交互→后端 API→抓取→结果展示）
- CI/CD：Lint/TypeCheck/Test/Build，预发布环境验证

## 实施步骤
1. 架构与数据层
- 整理 Supabase 表与索引脚本、环境变量与密钥管理
- 完善数据访问层：统一分页、重试、错误包装
2. 抓取与解析增强
- Playwright 上下文配置（UA/区域/时区/headers）；多站点选择器与货币解析完善
- 失败重试、快照记录；任务速率限制与并发控制
3. API 与导出
- 增强分页筛选、批量导出、时间范围导出
- JWT 与角色；任务调度器接口（创建周期任务）
4. 前端表格与详情
- 列表筛选与排序、批量操作；详情图表与收藏
- 列表抓取向导流程与 UX 优化
5. 测试与监控
- 单元/集成/E2E 测试落地；日志与指标面板
- CI/CD 工作流与预发布验证

## 验收标准
- E2E 打通：添加商品→执行抓取→表格展示→导出文件
- 多区域解析稳定（≥95% 成功率），抓取失败具备可追踪信息
- 前端表格交互流畅（分页/筛选/排序/批量操作）；导出正确
- 测试覆盖率达到约定阈值，CI 全绿

## 下一步
- 确认计划后，我将并行启动多智能体按分工执行并交付增量代码、测试与演示，过程中保持环境安全与密钥不泄露。